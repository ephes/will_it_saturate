---

title: Create wrk JSON


keywords: fastai
sidebar: home_sidebar



nb_path: "05_run_wrk_benchmark.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 05_run_wrk_benchmark.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">will_it_saturate.core</span> <span class="kn">import</span> <span class="n">Benchmark</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="c1361457-e2c2-4efc-8d5d-4d1dd793e57d"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#c1361457-e2c2-4efc-8d5d-4d1dd793e57d');

            setTimeout(function() {
                var nbb_cell_id = 10;
                var nbb_unformatted_code = "import json\n\nfrom pathlib import Path\n\nfrom will_it_saturate.core import Benchmark";
                var nbb_formatted_code = "import json\n\nfrom pathlib import Path\n\nfrom will_it_saturate.core import Benchmark";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">byte</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">gigabit</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">9</span>
<span class="n">bandwidth</span> <span class="o">=</span> <span class="n">gigabit</span> <span class="o">/</span> <span class="n">byte</span>

<span class="n">benchmark</span> <span class="o">=</span> <span class="n">Benchmark</span><span class="p">(</span><span class="n">bandwidth</span><span class="o">=</span><span class="n">bandwidth</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="c1"># file_sizes = [10 ** 7, 10 ** 6]</span>
<span class="n">file_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span> <span class="o">**</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">5</span><span class="p">]</span>
<span class="c1"># file_sizes = [10 ** 7]</span>
<span class="n">benchmark</span><span class="o">.</span><span class="n">create_rows</span><span class="p">(</span><span class="n">file_sizes</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="4e708607-d9ce-40bb-986d-41195f97980a"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#4e708607-d9ce-40bb-986d-41195f97980a');

            setTimeout(function() {
                var nbb_cell_id = 11;
                var nbb_unformatted_code = "byte = 8\ngigabit = 10 ** 9\nbandwidth = gigabit / byte\n\nbenchmark = Benchmark(bandwidth=bandwidth, duration=3)\n\n# file_sizes = [10 ** 7, 10 ** 6]\nfile_sizes = [10 ** 7, 10 ** 6, 10 ** 5]\n# file_sizes = [10 ** 7]\nbenchmark.create_rows(file_sizes)";
                var nbb_formatted_code = "byte = 8\ngigabit = 10 ** 9\nbandwidth = gigabit / byte\n\nbenchmark = Benchmark(bandwidth=bandwidth, duration=3)\n\n# file_sizes = [10 ** 7, 10 ** 6]\nfile_sizes = [10 ** 7, 10 ** 6, 10 ** 5]\n# file_sizes = [10 ** 7]\nbenchmark.create_rows(file_sizes)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">create_url_list</span><span class="p">(</span><span class="n">benchmark_row</span><span class="p">):</span>
    <span class="n">template</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">urls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">bf</span> <span class="ow">in</span> <span class="n">benchmark_row</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
        <span class="n">urls</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="o">**</span><span class="n">template</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">bf</span><span class="o">.</span><span class="n">path</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">urls</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="e0cf53fa-0e64-4d86-a2e5-904548a2a9f1"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#e0cf53fa-0e64-4d86-a2e5-904548a2a9f1');

            setTimeout(function() {
                var nbb_cell_id = 12;
                var nbb_unformatted_code = "def create_url_list(benchmark_row):\n    template = {\n        \"method\": \"GET\",\n    }\n    urls = []\n    for bf in benchmark_row.files:\n        urls.append({**template, \"path\": bf.path})\n    return urls";
                var nbb_formatted_code = "def create_url_list(benchmark_row):\n    template = {\n        \"method\": \"GET\",\n    }\n    urls = []\n    for bf in benchmark_row.files:\n        urls.append({**template, \"path\": bf.path})\n    return urls";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">br</span> <span class="ow">in</span> <span class="n">benchmark</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
    <span class="n">urls</span> <span class="o">=</span> <span class="n">create_url_list</span><span class="p">(</span><span class="n">br</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">urls</span><span class="p">))</span>
    <span class="n">json_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">br</span><span class="o">.</span><span class="n">data_root</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">br</span><span class="o">.</span><span class="n">base_path</span><span class="si">}</span><span class="s2">.json&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">json_path</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">json_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">urls</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>38
data/10000000_3_125000000.json
375
data/1000000_3_125000000.json
3750
data/100000_3_125000000.json
</pre>
</div>
</div>

<div class="output_area">




<div id="1085f829-47f1-4538-9596-0b4d242a2232"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#1085f829-47f1-4538-9596-0b4d242a2232');

            setTimeout(function() {
                var nbb_cell_id = 19;
                var nbb_unformatted_code = "for br in benchmark.rows:\n    urls = create_url_list(br)\n    print(len(urls))\n    json_path = Path(br.data_root) / f\"{br.base_path}.json\"\n    print(json_path)\n    with json_path.open(\"w\") as f:\n        f.write(json.dumps(urls))";
                var nbb_formatted_code = "for br in benchmark.rows:\n    urls = create_url_list(br)\n    print(len(urls))\n    json_path = Path(br.data_root) / f\"{br.base_path}.json\"\n    print(json_path)\n    with json_path.open(\"w\") as f:\n        f.write(json.dumps(urls))";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Create-wrk-Lua">Create wrk Lua<a class="anchor-link" href="#Create-wrk-Lua"> </a></h1>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">cerate_url_string</span><span class="p">(</span><span class="n">benchmark_row</span><span class="p">):</span>
    <span class="n">urls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">bf</span> <span class="ow">in</span> <span class="n">benchmark_row</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
        <span class="n">urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;    </span><span class="se">{{</span><span class="s1">path = &quot;/</span><span class="si">{</span><span class="n">bf</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s1">&quot;</span><span class="se">}}</span><span class="s1">,&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">urls</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="eb22f6fd-a287-417b-908f-12e1f49d9705"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#eb22f6fd-a287-417b-908f-12e1f49d9705');

            setTimeout(function() {
                var nbb_cell_id = 38;
                var nbb_unformatted_code = "def cerate_url_string(benchmark_row):\n    urls = []\n    for bf in benchmark_row.files:\n        urls.append(f'    {{path = \"/{bf.path}\"}},')\n    return \"\\n\".join(urls)";
                var nbb_formatted_code = "def cerate_url_string(benchmark_row):\n    urls = []\n    for bf in benchmark_row.files:\n        urls.append(f'    {{path = \"/{bf.path}\"}},')\n    return \"\\n\".join(urls)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">requests_head</span> <span class="o">=</span> <span class="s2">&quot;requests = {&quot;</span>
<span class="n">requests_tail</span> <span class="o">=</span> <span class="s2">&quot;}&quot;</span>

<span class="n">lua_body</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">print(requests[1])</span>

<span class="s2">if #requests &lt;= 0 then</span>
<span class="s2">  print(&quot;multiplerequests: No requests found.&quot;)</span>
<span class="s2">  os.exit()</span>
<span class="s2">end</span>

<span class="s2">print(&quot;multiplerequests: Found &quot; .. #requests .. &quot; requests&quot;)</span>

<span class="s2">counter = 1</span>
<span class="s2">request = function()</span>
<span class="s2">  -- Get the next requests array element</span>
<span class="s2">  local request_object = requests[counter]</span>

<span class="s2">  -- Increment the counter</span>
<span class="s2">  counter = counter + 1</span>

<span class="s2">  -- If the counter is longer than the requests array length then reset it</span>
<span class="s2">  if counter &gt; #requests then</span>
<span class="s2">    counter = 1</span>
<span class="s2">  end</span>

<span class="s2">  -- Return the request object with the current URL path</span>
<span class="s2">  return wrk.format(request_object.method, request_object.path, request_object.headers, request_object.body)</span>
<span class="s2">end</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="63a280f2-debc-4823-ab9f-3b2d9a2bd597"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#63a280f2-debc-4823-ab9f-3b2d9a2bd597');

            setTimeout(function() {
                var nbb_cell_id = 39;
                var nbb_unformatted_code = "requests_head = \"requests = {\"\nrequests_tail = \"}\"\n\nlua_body = \"\"\"\nprint(requests[1])\n\nif #requests <= 0 then\n  print(\"multiplerequests: No requests found.\")\n  os.exit()\nend\n\nprint(\"multiplerequests: Found \" .. #requests .. \" requests\")\n\ncounter = 1\nrequest = function()\n  -- Get the next requests array element\n  local request_object = requests[counter]\n\n  -- Increment the counter\n  counter = counter + 1\n\n  -- If the counter is longer than the requests array length then reset it\n  if counter > #requests then\n    counter = 1\n  end\n\n  -- Return the request object with the current URL path\n  return wrk.format(request_object.method, request_object.path, request_object.headers, request_object.body)\nend\n\"\"\"";
                var nbb_formatted_code = "requests_head = \"requests = {\"\nrequests_tail = \"}\"\n\nlua_body = \"\"\"\nprint(requests[1])\n\nif #requests <= 0 then\n  print(\"multiplerequests: No requests found.\")\n  os.exit()\nend\n\nprint(\"multiplerequests: Found \" .. #requests .. \" requests\")\n\ncounter = 1\nrequest = function()\n  -- Get the next requests array element\n  local request_object = requests[counter]\n\n  -- Increment the counter\n  counter = counter + 1\n\n  -- If the counter is longer than the requests array length then reset it\n  if counter > #requests then\n    counter = 1\n  end\n\n  -- Return the request object with the current URL path\n  return wrk.format(request_object.method, request_object.path, request_object.headers, request_object.body)\nend\n\"\"\"";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">br</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">benchmark</span><span class="o">.</span><span class="n">rows</span><span class="p">):</span>
    <span class="n">urls</span> <span class="o">=</span> <span class="n">cerate_url_string</span><span class="p">(</span><span class="n">br</span><span class="p">)</span>
    <span class="n">lua</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">requests_head</span><span class="p">,</span> <span class="n">urls</span><span class="p">,</span> <span class="n">requests_tail</span><span class="p">,</span> <span class="n">lua_body</span><span class="p">])</span>
    <span class="k">with</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;wrk</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">.lua&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">lua</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="d0c72e54-0a0a-49d1-aeec-01effe155903"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#d0c72e54-0a0a-49d1-aeec-01effe155903');

            setTimeout(function() {
                var nbb_cell_id = 40;
                var nbb_unformatted_code = "for num, br in enumerate(benchmark.rows):\n    urls = cerate_url_string(br)\n    lua = \"\\n\".join([requests_head, urls, requests_tail, lua_body])\n    with Path(f\"wrk{num}.lua\").open(\"w\") as f:\n        f.write(lua)";
                var nbb_formatted_code = "for num, br in enumerate(benchmark.rows):\n    urls = cerate_url_string(br)\n    lua = \"\\n\".join([requests_head, urls, requests_tail, lua_body])\n    with Path(f\"wrk{num}.lua\").open(\"w\") as f:\n        f.write(lua)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

