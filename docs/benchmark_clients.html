---

title: Caveats


keywords: fastai
sidebar: home_sidebar



nb_path: "04_benchmark_clients.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 04_benchmark_clients.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># set_start_method(&quot;fork&quot;)</span>
<span class="c1"># print(os.environ[&quot;OBJC_DISABLE_INITIALIZE_FORK_SAFETY&quot;])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="e4929933-18b2-4d51-bf5b-8a4d5901dfec"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#e4929933-18b2-4d51-bf5b-8a4d5901dfec');

            setTimeout(function() {
                var nbb_cell_id = 4;
                var nbb_unformatted_code = "# os.environ[\"OBJC_DISABLE_INITIALIZE_FORK_SAFETY\"] = \"YES\"\n# set_start_method(\"fork\")\n# print(os.environ[\"OBJC_DISABLE_INITIALIZE_FORK_SAFETY\"])";
                var nbb_formatted_code = "# os.environ[\"OBJC_DISABLE_INITIALIZE_FORK_SAFETY\"] = \"YES\"\n# set_start_method(\"fork\")\n# print(os.environ[\"OBJC_DISABLE_INITIALIZE_FORK_SAFETY\"])";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">byte</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">gigabit</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">9</span>
<span class="n">bandwidth</span> <span class="o">=</span> <span class="n">gigabit</span> <span class="o">/</span> <span class="n">byte</span>

<span class="c1"># file_sizes = [10 ** 7, 10 ** 6]</span>
<span class="n">file_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span> <span class="o">**</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">5</span><span class="p">]</span>
<span class="c1"># file_sizes = [10 ** 7]</span>

<span class="n">benchmark</span> <span class="o">=</span> <span class="n">Benchmark</span><span class="p">(</span>
    <span class="n">bandwidth</span><span class="o">=</span><span class="n">bandwidth</span><span class="p">,</span>
    <span class="n">duration</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">file_sizes</span><span class="o">=</span><span class="n">file_sizes</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">benchmark</span><span class="o">.</span><span class="n">create_rows</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="03089581-f472-4fff-9390-515a8b6638da"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#03089581-f472-4fff-9390-515a8b6638da');

            setTimeout(function() {
                var nbb_cell_id = 5;
                var nbb_unformatted_code = "# dont_test\n\nbyte = 8\ngigabit = 10 ** 9\nbandwidth = gigabit / byte\n\n# file_sizes = [10 ** 7, 10 ** 6]\nfile_sizes = [10 ** 7, 10 ** 6, 10 ** 5]\n# file_sizes = [10 ** 7]\n\nbenchmark = Benchmark(\n    bandwidth=bandwidth,\n    duration=3,\n    file_sizes=file_sizes,\n)\nbenchmark.create_rows()";
                var nbb_formatted_code = "# dont_test\n\nbyte = 8\ngigabit = 10 ** 9\nbandwidth = gigabit / byte\n\n# file_sizes = [10 ** 7, 10 ** 6]\nfile_sizes = [10 ** 7, 10 ** 6, 10 ** 5]\n# file_sizes = [10 ** 7]\n\nbenchmark = Benchmark(\n    bandwidth=bandwidth,\n    duration=3,\n    file_sizes=file_sizes,\n)\nbenchmark.create_rows()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="HttpxClient" class="doc_header"><code>class</code> <code>HttpxClient</code><a href="https://github.com/ephes/will_it_saturate/tree/main/will_it_saturate/client.py#L30" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>HttpxClient</code>(<strong><code>name</code></strong>:<code>str</code>=<em><code>'base_client'</code></em>) :: <a href="/will_it_saturate/core.html#BenchmarkClient"><code>BenchmarkClient</code></a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="run_httpx" class="doc_header"><code>run_httpx</code><a href="https://github.com/ephes/will_it_saturate/tree/main/will_it_saturate/client.py#L60" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>run_httpx</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="dd3d3867-00ea-440b-9909-4746f02fd279"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#dd3d3867-00ea-440b-9909-4746f02fd279');

            setTimeout(function() {
                var nbb_cell_id = 62;
                var nbb_unformatted_code = "# export\n\n\n# just here because of broken nbdev confusing lua with python\ncounter = 0\nrequest = None\n\n\nclass HttpxClient(BenchmarkClient):\n    async def measure_server(self, benchmark_row):\n        print(\"measure server\")\n        urls = [bf.url for bf in benchmark_row.files]\n        print(urls[0])\n        max_connections = min(benchmark_row.number_of_connections, 100)\n        limits = httpx.Limits(\n            max_keepalive_connections=5, max_connections=max_connections\n        )\n        start = time.perf_counter()\n        async with httpx.AsyncClient(limits=limits) as client:\n            responses = await asyncio.gather(*[client.get(url) for url in urls])\n        elapsed = time.perf_counter() - start\n        print(\"done: \", elapsed)\n        print(\"responses status: \", responses[0].status_code)\n        return elapsed, responses\n\n    def measure_in_new_process(self, benchmark_row):\n        print(\"new process\")\n        elapsed, responses = asyncio.run(self.measure_server(benchmark_row))\n        self.verify_checksums(benchmark_row.files, responses)\n        return elapsed\n\n    def measure(self, benchmark_row):\n        print(\"measure\")\n        with Pool(1) as p:\n            [result] = p.map(self.measure_in_new_process, [benchmark_row])\n        return result\n\n\ndef run_httpx():\n    byte = 8\n    gigabit = 10 ** 9\n    bandwidth = gigabit / byte\n\n    # file_sizes = [10 ** 7, 10 ** 6]\n    # file_sizes = [10 ** 7, 10 ** 6, 10 ** 5]\n    file_sizes = [10 ** 7]\n\n    benchmark = Benchmark(\n        bandwidth=bandwidth,\n        duration=3,\n        file_sizes=file_sizes,\n        servers=[BenchmarkServer(name=\"uvicorn\")],\n        clients=[HttpxClient(name=\"httpx\")],\n    )\n    benchmark.create_rows()\n    benchmark.run()\n    print(benchmark.results_frame)";
                var nbb_formatted_code = "# export\n\n\n# just here because of broken nbdev confusing lua with python\ncounter = 0\nrequest = None\n\n\nclass HttpxClient(BenchmarkClient):\n    async def measure_server(self, benchmark_row):\n        print(\"measure server\")\n        urls = [bf.url for bf in benchmark_row.files]\n        print(urls[0])\n        max_connections = min(benchmark_row.number_of_connections, 100)\n        limits = httpx.Limits(\n            max_keepalive_connections=5, max_connections=max_connections\n        )\n        start = time.perf_counter()\n        async with httpx.AsyncClient(limits=limits) as client:\n            responses = await asyncio.gather(*[client.get(url) for url in urls])\n        elapsed = time.perf_counter() - start\n        print(\"done: \", elapsed)\n        print(\"responses status: \", responses[0].status_code)\n        return elapsed, responses\n\n    def measure_in_new_process(self, benchmark_row):\n        print(\"new process\")\n        elapsed, responses = asyncio.run(self.measure_server(benchmark_row))\n        self.verify_checksums(benchmark_row.files, responses)\n        return elapsed\n\n    def measure(self, benchmark_row):\n        print(\"measure\")\n        with Pool(1) as p:\n            [result] = p.map(self.measure_in_new_process, [benchmark_row])\n        return result\n\n\ndef run_httpx():\n    byte = 8\n    gigabit = 10 ** 9\n    bandwidth = gigabit / byte\n\n    # file_sizes = [10 ** 7, 10 ** 6]\n    # file_sizes = [10 ** 7, 10 ** 6, 10 ** 5]\n    file_sizes = [10 ** 7]\n\n    benchmark = Benchmark(\n        bandwidth=bandwidth,\n        duration=3,\n        file_sizes=file_sizes,\n        servers=[BenchmarkServer(name=\"uvicorn\")],\n        clients=[HttpxClient(name=\"httpx\")],\n    )\n    benchmark.create_rows()\n    benchmark.run()\n    print(benchmark.results_frame)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="n">HttpxClient</span><span class="p">()</span>
<span class="n">elapsed</span><span class="p">,</span> <span class="n">responses</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">measure_server</span><span class="p">(</span><span class="n">benchmark</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>measure server
http://localhost:8000/data/10000000_3_125000000/0
done:  6.558793869999999
responses status:  200
6.558793869999999
</pre>
</div>
</div>

<div class="output_area">




<div id="745bc26f-3bae-45e3-8249-1e9587e41ba5"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#745bc26f-3bae-45e3-8249-1e9587e41ba5');

            setTimeout(function() {
                var nbb_cell_id = 7;
                var nbb_unformatted_code = "# dont_test\n\nclient = HttpxClient()\nelapsed, responses = await client.measure_server(benchmark.rows[0])\nprint(elapsed)";
                var nbb_formatted_code = "# dont_test\n\nclient = HttpxClient()\nelapsed, responses = await client.measure_server(benchmark.rows[0])\nprint(elapsed)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="aiohttp">aiohttp<a class="anchor-link" href="#aiohttp"> </a></h1>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AioHttpResponse" class="doc_header"><code>class</code> <code>AioHttpResponse</code><a href="https://github.com/ephes/will_it_saturate/tree/main/will_it_saturate/client.py#L83" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AioHttpResponse</code>(<strong><code>url</code></strong>, <strong><code>content</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AioHttpClient" class="doc_header"><code>class</code> <code>AioHttpClient</code><a href="https://github.com/ephes/will_it_saturate/tree/main/will_it_saturate/client.py#L89" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AioHttpClient</code>(<strong><code>name</code></strong>:<code>str</code>=<em><code>'base_client'</code></em>) :: <a href="/will_it_saturate/core.html#BenchmarkClient"><code>BenchmarkClient</code></a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="6b11e5a9-a699-4f3f-92a4-2be39cb9d8af"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#6b11e5a9-a699-4f3f-92a4-2be39cb9d8af');

            setTimeout(function() {
                var nbb_cell_id = 8;
                var nbb_unformatted_code = "# export\n\n\nclass AioHttpResponse:\n    def __init__(self, url, content):\n        self.url = url\n        self.content = content\n\n\nclass AioHttpClient(BenchmarkClient):\n    async def fetch_page(self, session, url):\n        async with session.get(url) as response:\n            content = await response.read()\n            return AioHttpResponse(url, content)\n\n    async def measure_server(self, benchmark_row):\n        urls = [bf.url for bf in benchmark_row.files]\n        max_connections = min(benchmark_row.number_of_connections, 200)\n        conn = aiohttp.TCPConnector(limit=max_connections)\n        responses = []\n        start = time.perf_counter()\n        async with aiohttp.ClientSession(connector=conn) as session:\n            tasks = [asyncio.create_task(self.fetch_page(session, url)) for url in urls]\n            responses = await asyncio.gather(*tasks)\n        elapsed = time.perf_counter() - start\n        return elapsed, responses\n\n    def measure_in_new_process(self, benchmark_row):\n        elapsed, responses = asyncio.run(self.measure_server(benchmark_row))\n        self.verify_checksums(benchmark_row.files, responses)\n        return elapsed\n\n    def measure(self, benchmark_row):\n        with Pool(1) as p:\n            [result] = p.map(self.measure_in_new_process, [benchmark_row])\n        return result";
                var nbb_formatted_code = "# export\n\n\nclass AioHttpResponse:\n    def __init__(self, url, content):\n        self.url = url\n        self.content = content\n\n\nclass AioHttpClient(BenchmarkClient):\n    async def fetch_page(self, session, url):\n        async with session.get(url) as response:\n            content = await response.read()\n            return AioHttpResponse(url, content)\n\n    async def measure_server(self, benchmark_row):\n        urls = [bf.url for bf in benchmark_row.files]\n        max_connections = min(benchmark_row.number_of_connections, 200)\n        conn = aiohttp.TCPConnector(limit=max_connections)\n        responses = []\n        start = time.perf_counter()\n        async with aiohttp.ClientSession(connector=conn) as session:\n            tasks = [asyncio.create_task(self.fetch_page(session, url)) for url in urls]\n            responses = await asyncio.gather(*tasks)\n        elapsed = time.perf_counter() - start\n        return elapsed, responses\n\n    def measure_in_new_process(self, benchmark_row):\n        elapsed, responses = asyncio.run(self.measure_server(benchmark_row))\n        self.verify_checksums(benchmark_row.files, responses)\n        return elapsed\n\n    def measure(self, benchmark_row):\n        with Pool(1) as p:\n            [result] = p.map(self.measure_in_new_process, [benchmark_row])\n        return result";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="n">AioHttpClient</span><span class="p">()</span>
<span class="n">elapsed</span><span class="p">,</span> <span class="n">responses</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">measure_server</span><span class="p">(</span><span class="n">benchmark</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>5.592472877999999
</pre>
</div>
</div>

<div class="output_area">




<div id="b4f57d3c-63e2-4b0f-92c9-1bc601fcb929"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#b4f57d3c-63e2-4b0f-92c9-1bc601fcb929');

            setTimeout(function() {
                var nbb_cell_id = 9;
                var nbb_unformatted_code = "# dont_test\n\nclient = AioHttpClient()\nelapsed, responses = await client.measure_server(benchmark.rows[0])\nprint(elapsed)";
                var nbb_formatted_code = "# dont_test\n\nclient = AioHttpClient()\nelapsed, responses = await client.measure_server(benchmark.rows[0])\nprint(elapsed)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="wrk">wrk<a class="anchor-link" href="#wrk"> </a></h1>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="WrkClient" class="doc_header"><code>class</code> <code>WrkClient</code><a href="https://github.com/ephes/will_it_saturate/tree/main/will_it_saturate/client.py#L120" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>WrkClient</code>(<strong><code>name</code></strong>:<code>str</code>=<em><code>'base_client'</code></em>, <strong><code>connections</code></strong>:<code>int</code>=<em><code>200</code></em>, <strong><code>duration</code></strong>:<code>int</code>=<em><code>20</code></em>, <strong><code>threads</code></strong>:<code>int</code>=<em><code>1</code></em>) :: <a href="/will_it_saturate/core.html#BenchmarkClient"><code>BenchmarkClient</code></a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="85ead920-df2c-400a-9413-fdd85e5691ff"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#85ead920-df2c-400a-9413-fdd85e5691ff');

            setTimeout(function() {
                var nbb_cell_id = 60;
                var nbb_unformatted_code = "# export\n\n\nclass WrkClient(BenchmarkClient):\n    connections: int = 200\n    duration: int = 20\n    threads: int = 1\n\n    def create_urls_string(self, benchmark_row):\n        urls = []\n        for bf in benchmark_row.files:\n            urls.append(f'    {{path = \"/{bf.path}\"}},')\n        return \"\\n\".join(urls)\n\n    def create_lua_script(self, benchmark_row):\n        requests_head = \"requests = {\"\n        requests_tail = \"}\"\n        lua_body = \"\"\"\nprint(requests[1])\n\nif #requests <= 0 then\n  print(\"multiplerequests: No requests found.\")\n  os.exit()\nend\n\nprint(\"multiplerequests: Found \" .. #requests .. \" requests\")\n\ncounter = 1\nrequest = function()\n  -- Get the next requests array element\n  local request_object = requests[counter]\n\n  -- Increment the counter\n  counter = counter + 1\n\n  -- If the counter is longer than the requests array length -> stop and exit\n  if counter > #requests then\n    wrk.thread:stop()\n    os.exit()\n  end\n\n  -- Return the request object with the current URL path\n  return wrk.format(request_object.method, request_object.path, request_object.headers, request_object.body)\nend\n        \"\"\"\n        urls = self.create_urls_string(benchmark_row)\n        lua = \"\\n\".join([requests_head, urls, requests_tail, lua_body])\n        with Path(f\"wrk.lua\").open(\"w\") as f:\n            f.write(lua)\n\n    def run_wrk(self):\n        kwargs = {\"capture_output\": True, \"text\": True}\n        start = time.perf_counter()\n        output = subprocess.run(\n            [\n                \"wrk\",\n                \"-c\",\n                str(self.connections),\n                \"-t\",\n                str(self.threads),\n                \"-s\",\n                \"wrk.lua\",\n                \"http://localhost:8000\",\n            ],\n            **kwargs,\n        )\n        elapsed = time.perf_counter() - start\n        print(output.stdout)\n        return elapsed\n\n    def measure(self, benchmark_row):\n        self.create_lua_script(benchmark_row)\n        elapsed = self.run_wrk()\n        return elapsed";
                var nbb_formatted_code = "# export\n\n\nclass WrkClient(BenchmarkClient):\n    connections: int = 200\n    duration: int = 20\n    threads: int = 1\n\n    def create_urls_string(self, benchmark_row):\n        urls = []\n        for bf in benchmark_row.files:\n            urls.append(f'    {{path = \"/{bf.path}\"}},')\n        return \"\\n\".join(urls)\n\n    def create_lua_script(self, benchmark_row):\n        requests_head = \"requests = {\"\n        requests_tail = \"}\"\n        lua_body = \"\"\"\nprint(requests[1])\n\nif #requests <= 0 then\n  print(\"multiplerequests: No requests found.\")\n  os.exit()\nend\n\nprint(\"multiplerequests: Found \" .. #requests .. \" requests\")\n\ncounter = 1\nrequest = function()\n  -- Get the next requests array element\n  local request_object = requests[counter]\n\n  -- Increment the counter\n  counter = counter + 1\n\n  -- If the counter is longer than the requests array length -> stop and exit\n  if counter > #requests then\n    wrk.thread:stop()\n    os.exit()\n  end\n\n  -- Return the request object with the current URL path\n  return wrk.format(request_object.method, request_object.path, request_object.headers, request_object.body)\nend\n        \"\"\"\n        urls = self.create_urls_string(benchmark_row)\n        lua = \"\\n\".join([requests_head, urls, requests_tail, lua_body])\n        with Path(f\"wrk.lua\").open(\"w\") as f:\n            f.write(lua)\n\n    def run_wrk(self):\n        kwargs = {\"capture_output\": True, \"text\": True}\n        start = time.perf_counter()\n        output = subprocess.run(\n            [\n                \"wrk\",\n                \"-c\",\n                str(self.connections),\n                \"-t\",\n                str(self.threads),\n                \"-s\",\n                \"wrk.lua\",\n                \"http://localhost:8000\",\n            ],\n            **kwargs,\n        )\n        elapsed = time.perf_counter() - start\n        print(output.stdout)\n        return elapsed\n\n    def measure(self, benchmark_row):\n        self.create_lua_script(benchmark_row)\n        elapsed = self.run_wrk()\n        return elapsed";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;capture_output&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;wrk&quot;</span><span class="p">,</span> <span class="s2">&quot;-c20&quot;</span><span class="p">,</span> <span class="s2">&quot;-t1&quot;</span><span class="p">,</span> <span class="s2">&quot;-d2&quot;</span><span class="p">,</span> <span class="s2">&quot;-s&quot;</span><span class="p">,</span> <span class="s2">&quot;wrk.lua&quot;</span><span class="p">,</span> <span class="s2">&quot;http://localhost:8000&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="c1"># output = subprocess.run([&quot;wrk&quot;, &quot;-d2&quot;, &quot;http://localhost:8000&quot;], **kwargs)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 2.01 ms, sys: 7.76 ms, total: 9.77 ms
Wall time: 2.01 s
</pre>
</div>
</div>

<div class="output_area">




<div id="28433857-bdfb-435d-82cc-688782151102"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#28433857-bdfb-435d-82cc-688782151102');

            setTimeout(function() {
                var nbb_cell_id = 56;
                var nbb_unformatted_code = "%%time\nkwargs = {\"capture_output\": True, \"text\": True}\noutput = subprocess.run([\"wrk\", \"-c20\", \"-t1\", \"-d2\", \"-s\", \"wrk.lua\", \"http://localhost:8000\"], **kwargs)\n# output = subprocess.run([\"wrk\", \"-d2\", \"http://localhost:8000\"], **kwargs)";
                var nbb_formatted_code = "%%time\nkwargs = {\"capture_output\": True, \"text\": True}\noutput = subprocess.run([\"wrk\", \"-c20\", \"-t1\", \"-d2\", \"-s\", \"wrk.lua\", \"http://localhost:8000\"], **kwargs)\n# output = subprocess.run([\"wrk\", \"-d2\", \"http://localhost:8000\"], **kwargs)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>table: 0x0b2a1918
multiplerequests: Found 38 requests
table: 0x0b309918
multiplerequests: Found 38 requests
Running 2s test @ http://localhost:8000
  1 threads and 20 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     0.00us    0.00us   0.00us     nan%
    Req/Sec     0.00      0.00     0.00       nan%
  0 requests in 2.00s, 140.03MB read
Requests/sec:      0.00
Transfer/sec:     69.96MB

</pre>
</div>
</div>

<div class="output_area">




<div id="2dbff6c9-a2d0-4f56-9a2e-cda8c0f1adff"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#2dbff6c9-a2d0-4f56-9a2e-cda8c0f1adff');

            setTimeout(function() {
                var nbb_cell_id = 57;
                var nbb_unformatted_code = "print(output.stdout)";
                var nbb_formatted_code = "print(output.stdout)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="n">WrkClient</span><span class="p">()</span>
<span class="n">elapsed</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="n">benchmark</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>table: 0x0c7e9918
multiplerequests: Found 38 requests
table: 0x0c851918
multiplerequests: Found 38 requests
Running 10s test @ http://localhost:8000
  1 threads and 20 connections

2.698344874999748
</pre>
</div>
</div>

<div class="output_area">




<div id="a31427fb-1678-4917-8b4c-01c873f79cda"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#a31427fb-1678-4917-8b4c-01c873f79cda');

            setTimeout(function() {
                var nbb_cell_id = 55;
                var nbb_unformatted_code = "# dont_test\n\nclient = WrkClient()\nelapsed = client.measure(benchmark.rows[0])\nprint(elapsed)";
                var nbb_formatted_code = "# dont_test\n\nclient = WrkClient()\nelapsed = client.measure(benchmark.rows[0])\nprint(elapsed)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Export">Export<a class="anchor-link" href="#Export"> </a></h1>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev.export</span> <span class="kn">import</span> <span class="n">notebook2script</span>

<span class="n">notebook2script</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Converted 00_core.ipynb.
Converted 01_serve_files_uvicorn.ipynb.
Converted 02_benchmark_clients.ipynb.
Converted 03_run_benchmark.ipynb.
Converted 04_use_nginx_to_serve_files.ipynb.
Converted 05_run_wrk_benchmark.ipynb.
Converted 06_fastapi_uvicorn_server.ipynb.
Converted 07_nginx_docker_server.ipynb.
Converted index.ipynb.
</pre>
</div>
</div>

<div class="output_area">




<div id="39daba0a-91fc-40fe-86f9-c34e21c26c19"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#39daba0a-91fc-40fe-86f9-c34e21c26c19');

            setTimeout(function() {
                var nbb_cell_id = 63;
                var nbb_unformatted_code = "# dont_test\n\nfrom nbdev.export import notebook2script\n\nnotebook2script()";
                var nbb_formatted_code = "# dont_test\n\nfrom nbdev.export import notebook2script\n\nnotebook2script()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

